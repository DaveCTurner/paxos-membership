
%% bare_jrnl.tex
%% V1.4b
%% 2015/08/26
%% by Michael Shell
%% see http://www.michaelshell.org/
%% for current contact information.
%%
%% This is a skeleton file demonstrating the use of IEEEtran.cls
%% (requires IEEEtran.cls version 1.8b or later) with an IEEE
%% journal paper.
%%
%% Support sites:
%% http://www.michaelshell.org/tex/ieeetran/
%% http://www.ctan.org/pkg/ieeetran
%% and
%% http://www.ieee.org/

%%*************************************************************************
%% Legal Notice:
%% This code is offered as-is without any warranty either expressed or
%% implied; without even the implied warranty of MERCHANTABILITY or
%% FITNESS FOR A PARTICULAR PURPOSE! 
%% User assumes all risk.
%% In no event shall the IEEE or any contributor to this code be liable for
%% any damages or losses, including, but not limited to, incidental,
%% consequential, or any other damages, resulting from the use or misuse
%% of any information contained here.
%%
%% All comments are the opinions of their respective authors and are not
%% necessarily endorsed by the IEEE.
%%
%% This work is distributed under the LaTeX Project Public License (LPPL)
%% ( http://www.latex-project.org/ ) version 1.3, and may be freely used,
%% distributed and modified. A copy of the LPPL, version 1.3, is included
%% in the base LaTeX documentation of all distributions of LaTeX released
%% 2003/12/01 or later.
%% Retain all contribution notices and credits.
%% ** Modified files should be clearly indicated as such, including  **
%% ** renaming them and changing author support contact information. **
%%*************************************************************************


% *** Authors should verify (and, if needed, correct) their LaTeX system  ***
% *** with the testflow diagnostic prior to trusting their LaTeX platform ***
% *** with production work. The IEEE's font choices and paper sizes can   ***
% *** trigger bugs that do not appear when using other class files.       ***                          ***
% The testflow support page is at:
% http://www.michaelshell.org/tex/testflow/



\documentclass[journal]{IEEEtran}
%
% If IEEEtran.cls has not been installed into the LaTeX system files,
% manually specify the path to it like:
% \documentclass[journal]{../sty/IEEEtran}





% Some very useful LaTeX packages include:
% (uncomment the ones you want to load)


% *** MISC UTILITY PACKAGES ***
%
%\usepackage{ifpdf}
% Heiko Oberdiek's ifpdf.sty is very useful if you need conditional
% compilation based on whether the output is pdf or dvi.
% usage:
% \ifpdf
%   % pdf code
% \else
%   % dvi code
% \fi
% The latest version of ifpdf.sty can be obtained from:
% http://www.ctan.org/pkg/ifpdf
% Also, note that IEEEtran.cls V1.7 and later provides a builtin
% \ifCLASSINFOpdf conditional that works the same way.
% When switching from latex to pdflatex and vice-versa, the compiler may
% have to be run twice to clear warning/error messages.





% *** CITATION PACKAGES ***
%
\usepackage{cite}
% cite.sty was written by Donald Arseneau
% V1.6 and later of IEEEtran pre-defines the format of the cite.sty package
% \cite{} output to follow that of the IEEE. Loading the cite package will
% result in citation numbers being automatically sorted and properly
% "compressed/ranged". e.g., [1], [9], [2], [7], [5], [6] without using
% cite.sty will become [1], [2], [5]--[7], [9] using cite.sty. cite.sty's
% \cite will automatically add leading space, if needed. Use cite.sty's
% noadjust option (cite.sty V3.8 and later) if you want to turn this off
% such as if a citation ever needs to be enclosed in parenthesis.
% cite.sty is already installed on most LaTeX systems. Be sure and use
% version 5.0 (2009-03-20) and later if using hyperref.sty.
% The latest version can be obtained at:
% http://www.ctan.org/pkg/cite
% The documentation is contained in the cite.sty file itself.






% *** GRAPHICS RELATED PACKAGES ***
%
\ifCLASSINFOpdf
  \usepackage[pdftex]{graphicx}
  % declare the path(s) where your graphic files are
  % \graphicspath{{../pdf/}{../jpeg/}}
  % and their extensions so you won't have to specify these with
  % every instance of \includegraphics
  % \DeclareGraphicsExtensions{.pdf,.jpeg,.png}
\else
  % or other class option (dvipsone, dvipdf, if not using dvips). graphicx
  % will default to the driver specified in the system graphics.cfg if no
  % driver is specified.
  % \usepackage[dvips]{graphicx}
  % declare the path(s) where your graphic files are
  % \graphicspath{{../eps/}}
  % and their extensions so you won't have to specify these with
  % every instance of \includegraphics
  % \DeclareGraphicsExtensions{.eps}
\fi
% graphicx was written by David Carlisle and Sebastian Rahtz. It is
% required if you want graphics, photos, etc. graphicx.sty is already
% installed on most LaTeX systems. The latest version and documentation
% can be obtained at: 
% http://www.ctan.org/pkg/graphicx
% Another good source of documentation is "Using Imported Graphics in
% LaTeX2e" by Keith Reckdahl which can be found at:
% http://www.ctan.org/pkg/epslatex
%
% latex, and pdflatex in dvi mode, support graphics in encapsulated
% postscript (.eps) format. pdflatex in pdf mode supports graphics
% in .pdf, .jpeg, .png and .mps (metapost) formats. Users should ensure
% that all non-photo figures use a vector format (.eps, .pdf, .mps) and
% not a bitmapped formats (.jpeg, .png). The IEEE frowns on bitmapped formats
% which can result in "jaggedy"/blurry rendering of lines and letters as
% well as large increases in file sizes.
%
% You can find documentation about the pdfTeX application at:
% http://www.tug.org/applications/pdftex





% *** MATH PACKAGES ***
%
\usepackage{amsmath}
\usepackage{amssymb}

\usepackage{amsthm}
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}[theorem]{Corollary}
% A popular package from the American Mathematical Society that provides
% many useful and powerful commands for dealing with mathematics.
%
% Note that the amsmath package sets \interdisplaylinepenalty to 10000
% thus preventing page breaks from occurring within multiline equations. Use:
%\interdisplaylinepenalty=2500
% after loading amsmath to restore such page breaks as IEEEtran.cls normally
% does. amsmath.sty is already installed on most LaTeX systems. The latest
% version and documentation can be obtained at:
% http://www.ctan.org/pkg/amsmath





% *** SPECIALIZED LIST PACKAGES ***
%
%\usepackage{algorithmic}
% algorithmic.sty was written by Peter Williams and Rogerio Brito.
% This package provides an algorithmic environment fo describing algorithms.
% You can use the algorithmic environment in-text or within a figure
% environment to provide for a floating algorithm. Do NOT use the algorithm
% floating environment provided by algorithm.sty (by the same authors) or
% algorithm2e.sty (by Christophe Fiorio) as the IEEE does not use dedicated
% algorithm float types and packages that provide these will not provide
% correct IEEE style captions. The latest version and documentation of
% algorithmic.sty can be obtained at:
% http://www.ctan.org/pkg/algorithms
% Also of interest may be the (relatively newer and more customizable)
% algorithmicx.sty package by Szasz Janos:
% http://www.ctan.org/pkg/algorithmicx




% *** ALIGNMENT PACKAGES ***
%
%\usepackage{array}
% Frank Mittelbach's and David Carlisle's array.sty patches and improves
% the standard LaTeX2e array and tabular environments to provide better
% appearance and additional user controls. As the default LaTeX2e table
% generation code is lacking to the point of almost being broken with
% respect to the quality of the end results, all users are strongly
% advised to use an enhanced (at the very least that provided by array.sty)
% set of table tools. array.sty is already installed on most systems. The
% latest version and documentation can be obtained at:
% http://www.ctan.org/pkg/array


% IEEEtran contains the IEEEeqnarray family of commands that can be used to
% generate multiline equations as well as matrices, tables, etc., of high
% quality.




% *** SUBFIGURE PACKAGES ***
%\ifCLASSOPTIONcompsoc
%  \usepackage[caption=false,font=normalsize,labelfont=sf,textfont=sf]{subfig}
%\else
%  \usepackage[caption=false,font=footnotesize]{subfig}
%\fi
% subfig.sty, written by Steven Douglas Cochran, is the modern replacement
% for subfigure.sty, the latter of which is no longer maintained and is
% incompatible with some LaTeX packages including fixltx2e. However,
% subfig.sty requires and automatically loads Axel Sommerfeldt's caption.sty
% which will override IEEEtran.cls' handling of captions and this will result
% in non-IEEE style figure/table captions. To prevent this problem, be sure
% and invoke subfig.sty's "caption=false" package option (available since
% subfig.sty version 1.3, 2005/06/28) as this is will preserve IEEEtran.cls
% handling of captions.
% Note that the Computer Society format requires a larger sans serif font
% than the serif footnote size font used in traditional IEEE formatting
% and thus the need to invoke different subfig.sty package options depending
% on whether compsoc mode has been enabled.
%
% The latest version and documentation of subfig.sty can be obtained at:
% http://www.ctan.org/pkg/subfig




% *** FLOAT PACKAGES ***
%
%\usepackage{fixltx2e}
% fixltx2e, the successor to the earlier fix2col.sty, was written by
% Frank Mittelbach and David Carlisle. This package corrects a few problems
% in the LaTeX2e kernel, the most notable of which is that in current
% LaTeX2e releases, the ordering of single and double column floats is not
% guaranteed to be preserved. Thus, an unpatched LaTeX2e can allow a
% single column figure to be placed prior to an earlier double column
% figure.
% Be aware that LaTeX2e kernels dated 2015 and later have fixltx2e.sty's
% corrections already built into the system in which case a warning will
% be issued if an attempt is made to load fixltx2e.sty as it is no longer
% needed.
% The latest version and documentation can be found at:
% http://www.ctan.org/pkg/fixltx2e


%\usepackage{stfloats}
% stfloats.sty was written by Sigitas Tolusis. This package gives LaTeX2e
% the ability to do double column floats at the bottom of the page as well
% as the top. (e.g., "\begin{figure*}[!b]" is not normally possible in
% LaTeX2e). It also provides a command:
%\fnbelowfloat
% to enable the placement of footnotes below bottom floats (the standard
% LaTeX2e kernel puts them above bottom floats). This is an invasive package
% which rewrites many portions of the LaTeX2e float routines. It may not work
% with other packages that modify the LaTeX2e float routines. The latest
% version and documentation can be obtained at:
% http://www.ctan.org/pkg/stfloats
% Do not use the stfloats baselinefloat ability as the IEEE does not allow
% \baselineskip to stretch. Authors submitting work to the IEEE should note
% that the IEEE rarely uses double column equations and that authors should try
% to avoid such use. Do not be tempted to use the cuted.sty or midfloat.sty
% packages (also by Sigitas Tolusis) as the IEEE does not format its papers in
% such ways.
% Do not attempt to use stfloats with fixltx2e as they are incompatible.
% Instead, use Morten Hogholm'a dblfloatfix which combines the features
% of both fixltx2e and stfloats:
%
% \usepackage{dblfloatfix}
% The latest version can be found at:
% http://www.ctan.org/pkg/dblfloatfix




%\ifCLASSOPTIONcaptionsoff
%  \usepackage[nomarkers]{endfloat}
% \let\MYoriglatexcaption\caption
% \renewcommand{\caption}[2][\relax]{\MYoriglatexcaption[#2]{#2}}
%\fi
% endfloat.sty was written by James Darrell McCauley, Jeff Goldberg and 
% Axel Sommerfeldt. This package may be useful when used in conjunction with 
% IEEEtran.cls'  captionsoff option. Some IEEE journals/societies require that
% submissions have lists of figures/tables at the end of the paper and that
% figures/tables without any captions are placed on a page by themselves at
% the end of the document. If needed, the draftcls IEEEtran class option or
% \CLASSINPUTbaselinestretch interface can be used to increase the line
% spacing as well. Be sure and use the nomarkers option of endfloat to
% prevent endfloat from "marking" where the figures would have been placed
% in the text. The two hack lines of code above are a slight modification of
% that suggested by in the endfloat docs (section 8.4.1) to ensure that
% the full captions always appear in the list of figures/tables - even if
% the user used the short optional argument of \caption[]{}.
% IEEE papers do not typically make use of \caption[]'s optional argument,
% so this should not be an issue. A similar trick can be used to disable
% captions of packages such as subfig.sty that lack options to turn off
% the subcaptions:
% For subfig.sty:
% \let\MYorigsubfloat\subfloat
% \renewcommand{\subfloat}[2][\relax]{\MYorigsubfloat[]{#2}}
% However, the above trick will not work if both optional arguments of
% the \subfloat command are used. Furthermore, there needs to be a
% description of each subfigure *somewhere* and endfloat does not add
% subfigure captions to its list of figures. Thus, the best approach is to
% avoid the use of subfigure captions (many IEEE journals avoid them anyway)
% and instead reference/explain all the subfigures within the main caption.
% The latest version of endfloat.sty and its documentation can obtained at:
% http://www.ctan.org/pkg/endfloat
%
% The IEEEtran \ifCLASSOPTIONcaptionsoff conditional can also be used
% later in the document, say, to conditionally put the References on a 
% page by themselves.




% *** PDF, URL AND HYPERLINK PACKAGES ***
%
%\usepackage{url}
% url.sty was written by Donald Arseneau. It provides better support for
% handling and breaking URLs. url.sty is already installed on most LaTeX
% systems. The latest version and documentation can be obtained at:
% http://www.ctan.org/pkg/url
% Basically, \url{my_url_here}.




% *** Do not adjust lengths that control margins, column widths, etc. ***
% *** Do not use packages that alter fonts (such as pslatex).         ***
% There should be no need to do such things with IEEEtran.cls V1.6 and later.
% (Unless specifically asked to do so by the journal or conference you plan
% to submit to, of course. )


% correct bad hyphenation here
\hyphenation{op-tical net-works semi-conduc-tor}

\def\mytitle{Unbounded Pipelining in Dynamically Reconfigurable Paxos Clusters}
\include{inc}

\begin{document}
%
% paper title
% Titles are generally capitalized except for words such as a, an, and, as,
% at, but, by, for, in, nor, of, on, or, the, to and up, which are usually
% not capitalized unless they are the first or last word of the title.
% Linebreaks \\ can be used within to get better formatting as desired.
% Do not put math or special symbols in the title.
\title{\mytitle}
%
%
% author names and IEEE memberships
% note positions of commas and nonbreaking spaces ( ~ ) LaTeX will not break
% a structure at a ~ so this keeps an author's name from being broken across
% two lines.
% use \thanks{} to gain access to the first footnote area
% a separate \thanks must be used for each paragraph as LaTeX2e's \thanks
% was not built to handle multiple paragraphs
%

\author{David C. Turner% <-this % stops a space
\thanks{Manuscript received \pubdate, version \gitid.}%
\thanks{The author is with the Operations and Planning Systems division of
Tracsis plc, Leeds LS2 9DF, United Kingdom (email:
d.turner@tracsis.com)}% <-this % stops a space
\thanks{Digital Object Identifier 99.9999/ZZZ.9999.999999}
%\thanks{Manuscript received April 19, 2005; revised August 26, 2015.}} TODO
}

% note the % following the last \IEEEmembership and also \thanks - 
% these prevent an unwanted space from occurring between the last author name
% and the end of the author line. i.e., if you had this:
% 
% \author{....lastname \thanks{...} \thanks{...} }
%                     ^------------^------------^----Do not want these spaces!
%
% a space would be appended to the last name and could cause every name on that
% line to be shifted left slightly. This is one of those "LaTeX things". For
% instance, "\textbf{A} \textbf{B}" will typeset as "A B" not "AB". To get
% "AB" then you have to do: "\textbf{A}\textbf{B}"
% \thanks is no different in this regard, so shield the last } of each \thanks
% that ends a line with a % and do not let a space in before the next \thanks.
% Spaces after \IEEEmembership other than the last one are OK (and needed) as
% you are supposed to have spaces between the names. For what it is worth,
% this is a minor point as most people would not even notice if the said evil
% space somehow managed to creep in.



% The paper headers
\markboth{IEEE Transactions on Parallel and Distributed Systems,~Vol.~?, No.~?,
?~?}%TODO Journal of \LaTeX\ Class Files,~Vol.~14, No.~8, August~2015}%
{Turner: \mytitle}
% The only time the second header will appear is for the odd numbered pages
% after the title page when using the twoside option.
% 
% *** Note that you probably will NOT want to include the author's ***
% *** name in the headers of peer review papers.                   ***
% You can use \ifCLASSOPTIONpeerreview for conditional compilation here if
% you desire.




% If you want to put a publisher's ID mark on the page you can do it like
% this:
%\IEEEpubid{1045--9219~\copyright~2016 IEEE.  Personal use is permitted, but republication/redistribution requires IEEE permission.}
% Remember, if you use this you must call \IEEEpubidadjcol in the second
% column for its text to clear the IEEEpubid mark.



% use for special paper notices
%\IEEEspecialpapernotice{(Invited Paper)}




% make the title area
\maketitle

% As a general rule, do not put math, special symbols or citations in the
% abstract or keywords.
\begin{abstract}Paxos and Raft are algorithms for building fault-tolerant
distributed systems. Practical implementations of this kind of system must
support dynamic reconfiguration in order to be able to replace failed
components and perform other administrative tasks. Paxos can achieve high
performance by pipelining (starting work on new requests before existing
requests have completed) but typically bounds the length of the pipeline to
ensure consistency during reconfiguration. Raft also supports pipelining and
imposes no such bound on concurrent requests, preserving consistency instead by
restricting which reconfigurations may be performed. It is shown that Paxos can
be extended to support a more general form of reconfiguration which subsumes
the original bounded-pipeline approach as well as Raft-like fully-concurrent
reconfigurations and more besides.\end{abstract}

% Note that keywords are not normally used for peerreview papers.
\begin{IEEEkeywords}
Distributed algorithms, fault tolerance.
\end{IEEEkeywords}






% For peer review papers, you can put extra information on the cover
% page as needed:
% \ifCLASSOPTIONpeerreview
% \begin{center} \bfseries EDICS Category: 3-BBND \end{center}
% \fi
%
% For peerreview papers, this IEEEtran command inserts a page break and
% creates the second title. It will be ignored for other modes.
\IEEEpeerreviewmaketitle

\section{Introduction}

\IEEEPARstart{P}{axos} \cite{part-time-parliament} AND RAFT\cite{raft} are
algorithms for achieving consensus on (or \textit{choosing}) a sequence $v_0,
v_1, \ldots$ of values in a distributed, fault-tolerant fashion. They guarantee
system-wide \textit{consistency}, in the sense that the values chosen are
guaranteed to be equal across the whole system even in the presence of
failures. They typically run on a cluster of $2f+1$ nodes, where $f$ is the
number of faulty nodes that should be tolerated, and consensus is achieved on a
value $v_i$ when $\ge f+1$ (i.e. a majority) of the nodes agree.  The
(nonempty) sets of nodes involved in reaching consensus are known as
\textit{quorums} and the set of quorums in use is known as the
\textit{configuration} of the cluster.

It is normally necessary to be able to dynamically reconfigure a cluster by
adding or removing nodes while it is running. It is crucial that all
participating nodes agree on the cluster configuration, and this can be
achieved by tracking the configuration with the consensus algorithm itself
using a state machine whose transitions occur when particular values in the
sequence are chosen.

In Paxos, each value $v_i$ is chosen using a separate instance $i$ of a
two-phase consensus protocol known as \textit{Synod}. The full Paxos algorithm
essentially runs an infinite sequence of Synod protocols in parallel: it starts
by running phase I of all instances at once and then runs phase II of each
instance in turn to yield the desired sequence of chosen values. It normally
remains in phase II for extended periods of time, but will return to phase I if
certain nodes become faulty, or if messages between certain pairs of nodes
cease to be delivered reliably for a period, or if the configuration changes.
Raft's pattern of execution is similar.

Both algorithms allow for \textit{pipelining} \cite{smart} whereby later values
can be proposed before earlier ones have been chosen. To ensure that this
preserves consistency is nontrivial because a value may only be proposed once a
quorum of nodes are ready for it but the quorums change as values are chosen.
Paxos implementations typically solve this problem by limiting the length of
the pipeline to some $\alpha > 0$ and requiring that a configuration change
chosen at instance $i$ does not take effect until at least instance $i +
\alpha$.  Raft imposes no limit on the number of concurrently-running
instances and instead ensures consistency by only allowing certain
reconfigurations to take place, and then performs sequences of these restricted
reconfigurations in order to achieve an arbitrary reconfiguration.

The choice of the pipeline length parameter $\alpha$ is a little delicate: too
small and the system may suffer from poor performance due to lack of
parallelism, but too large and configuration changes can take an unreasonably
long time to complete. It would be better to be able to vary the value of
$\alpha$ as the system is running rather than having to choose it up-front, but
there seems to be no published method for doing so safely. It would be better
still to be able to impose this limit only when a configuration change is in
progress and allow an unbounded pipeline while the configuration is static. But
the need for any such limit seems inelegant\cite{reconfiguring-a-state-machine}
particularly when compared with Raft's approach.

Here it is shown that the value of $\alpha$ can indeed be varied safely as the
system is running and that the pipeline may indeed remain unbounded while the
configuration is static. It is also shown that the pipeline may safely remain
unbounded even during a configuration change as long as the reconfiguration
satisfies the conditions described in section \ref{configuration-changes}
below. In particular, this result unifies and generalises the reconfigurations
supported by both Raft and Dynamic Paxos\cite{cheap-paxos} as shown in section
\ref{types-of-configuration-change}.

The algorithm is presented here in its entirety for the sake of consistency of
notation and because it modifies the original algorithm in ways that invalidate
its consistency and liveness proofs. Reworked proofs are included in section
\ref{liveness} and appendices \ref{synod-safety} and \ref{paxos-invariants} and
differences from the original are discussed throughout.

%\IEEEpubidadjcol %must be in 2nd col of 1st page

\section{The Synod Algorithm}

Synod\cite{part-time-parliament} is an algorithm for achieving consensus on a
single value in a distributed system comprising a set of nodes which can
communicate by sending messages to each other. Communication is asynchronous
but not Byzantine, in the sense that messages may be delayed, reordered,
duplicated and dropped but not corrupted.

Let $\mathbb B$ be a set of \textit{ballot identifiers} with a wellfounded
total order $\prec$. Let $\mathbb A$ be a set of \textit{node identifiers} and
let $\mathbb V$ be the set of values that may be chosen.

\def\prep#1{\mathbf{prepare}(#1)}
\def\mprom#1#2#3{\mathbf{promised}_{\ge #1}(#2,#3)}
\def\fprom#1#2#3{\mathbf{promised}_{#1}(#2,#3)}
\def\bprom#1#2#3#4{\mathbf{promised}_{#1}(#2,#3;#4)}
\def\prop#1#2{\mathbf{proposed}_{#1}(#2)}
\def\acc#1#2#3{\mathbf{accepted}_{#1}(#2,#3)}
\def\chosen#1#2{\mathbf{chosen}_{#1}(#2)}
\def\owner#1{\mathrm{owner}(#1)}

The Synod algorithm involves four kinds of message, described below.
Throughout, $a \in \mathbb A$ and $b, b' \in \mathbb B$.  Phase I starts with
the broadcast of a \textit{prepare} message $\prep{b}$ to which each node may
respond with a \textit{promise} message, either a \textit{free promise} written
$\fprom{}{a}{b}$ or a \textit{forced promise} written $\bprom{}{a}{b}{b'}$
where $a$ identifies the responding node.  Phase II starts with the broadcast
of a \textit{proposal} message $\prop{}{b}$ to which each node $a$ may respond
with an \textit{acceptance} message $\acc{}{a}{b}$.  It is convenient also to
use these symbols as predicates indicating whether the corresponding messages
have been sent, and to add another predicate $\chosen{}{b}$ which indicates
that the ballot $b$ may be chosen.

There is a function $v : \mathbb B \to \mathbb V$ assigning a value to each
ballot, discussed in more detail in section \ref{value-function} below, and the
system satisfies a set of invariants as described in appendix
\ref{synod-safety} from which theorem \ref{synod-safety-theorem} shows that
consistency is guaranteed: \[\textrm{if } \chosen{}{b} \textrm{ and }
\chosen{}{b'} \textrm { then } v(b) = v(b').\]

Each node operates as a state machine whose transitions are caused by the
receipts of messages. A node may emit $\prop{}{b}$ when it considers phase I to
be complete at ballot $b$, which is when promise messages for $b$ have been
received from a quorum of nodes, and similarly may deduce $\chosen{}{b}$ when
it considers phase II to be complete at $b$, which is when acceptances of $b$
from a quorum of nodes have been received. The phase-I and phase-II quorums are
chosen so as to always contain at least one node in common, but may vary
depending on the ballot $b$ and the phase as discussed in section
\ref{per-phase-quorums} below.

\subsection{Implementing the value function}\label{value-function}

In the original presentation of the Synod algorithm, the values of ballots are
carried along with their identifiers in the messages $\bprom{}{a}{b}{ b',v(b')
}$, $\prop{}{ b,v(b)}$ and $\acc{}{a}{ b,v(b) }$. Observation O4 in
\cite{cheap-paxos} notes that these values can be replaced in some cases by
hashes, which is useful if the values themselves are expensive to transmit
between nodes. This can be taken one step further and the values can be
completely elided from the messages that take part in the Synod protocol,
allowing considerably more freedom in the implementation of the function $v$
without sacrificing consistency. This is useful because the values themselves
may be large or expensive to transport across the network but the messages
involved in the Synod protocol are typically very small if the values are
removed.

Although it appears that the function $v$ is fixed, in practice it is allowed
to change as the system runs. Treating it as fixed simplifies the consistency
proof and highlights that its values need not be included in all messages, but
means that the system cannot be shown to satisfy any useful liveness
properties.  To recover liveness, it is enough to note that if the invariants
of appendix \ref{synod-safety} are satisfied with a value function $v$ then
they continue to be satisfied if $v$ is replaced by another value function $v'$
that agrees with $v$ on proposed ballots, i.e. where $v(b) = v'(b)$ if
$\prop{}{b}$ but not necessarily otherwise. Since only $\owner{b}$ may propose
$b$, if it has not yet proposed a value for $b$ it can prove that
$\neg\prop{}{b}$ and therefore freely modify $v(b)$.

It is also important for liveness that the implementation of $v$ is resilient
to the same failure modes as the rest of the system. Since the value of each
ballot $b$ has at most one writer, $\owner{b}$, it is possible to think of $v$
as an insert-only set of pairs ${\{ \langle b, v(b) \rangle \mid \prop{}{b}
\}}$ which is an example of a convergent replicated data type\cite{crdts} and
can therefore be implemented simply and robustly in a distributed system.
Indeed the original presentation can be seen as containing such an
implementation, where the inclusion of values in all messages ensures
convergence occurs as quickly as possible, and replicating this set across all
${2f+1}$ nodes ensures $v$ itself may be resilient to as many as $2f$ failures.
Cheap Paxos\cite{cheap-paxos} is cheaper partly because it replicates $v$
across just the ${f+1}$ primary processors, with the $f$ auxiliary processors
storing just the hashes of values to ensure integrity.

It is also worth comparing this approach to that of Vertical
Paxos\cite{vertical-paxos} which takes care to ensure that the system state is
completely transferred between nodes before they start to participate fully in
the cluster, with certain optimisations to handle the fact that this state
transfer could be an expensive and time-consuming operation involving a very
large quantity of data. However if the implementation of $v$ is separated out
from the consensus algorithm itself then the quantity of data that must be
transferred between consensus nodes becomes small enough that it needs no
special treatment.

\subsection{Per-phase quorums}\label{per-phase-quorums}

\def\I#1#2{{#1}^\textrm{I}_{#2}}
\def\II#1#2{{#1}^\textrm{II}_{#2}}
\def\QI#1{\I{Q}{#1}}
\def\QII#1{\II{Q}{#1}}

The heart of the consistency property of the Synod algorithm is that the set of
nodes involved in completing phase I must always intersect the set of nodes
involved in completing phase II so that there is at least one node to carry
information between the two phases. Write $Q_1 \frown Q_2$ to indicate that
every element of $Q_1$ intersects every element of $Q_2$ or more formally
define $Q_1 \frown Q_2$ iff every $q_1 \in Q_1$ and $q_2 \in Q_2$ have ${q_1
\cap q_2 \ne \varnothing}$. Write $\QI{}(b)$ and $\QII{}(b)$ for the sets of
phase-I and phase-II quorums for ballot $b$ respectively.

In the original presentation of the Synod algorithm any (weighted) majority of
the nodes could be used as a quorum, so that $\QI{}(b_1) = \QII{}(b_2)$ and
hence $\QI{}(b_1) \frown \QII{}(b_2)$ for all $b_1$ and $b_2$ since all
majorities intersect. The proof of theorem \ref{synod-safety-theorem} in
appendix \ref{synod-safety} is a generalisation of the original one to
demonstrate that consistency still holds even under the weaker assumption that
$\QI{}(b_1) \frown \QII{}(b_2)$ only need hold when $\prop{}{b_1}$,
$\chosen{}{b_2}$ and $b_1 \succ b_2$.

\section{The Paxos algorithm}

Conceptually, Paxos is a sequence of distinct instances of the Synod algorithm
all running simultaneously. To achieve this, the messages of the Synod
algorithm above are indexed with the instance number $i \in \mathbb N$:
$\fprom{i}{a}{b}$, $\bprom{i}{a}{b}{b'}$, $\prop{i}{b}$ and $\acc{i}{a}{b}$.
There is another kind of message known as a \textit{multi-promise}, written
$\mprom{i}{a}{b}$, which can be thought of as standing for the infinite set of
free promises ${\{ \fprom{j}{a}{b} \mid j \ge i \}}$. The predicate
$\chosen{i}{b}$ is also indexed by the instance number $i$, but prepare
messages $\prep{b}$ apply to all instances so do not need to be indexed.

As in the Synod algorithm, phase I starts with a broadcast of $\prep{b}$ for
some $b$ to which each node $a$ may respond with a set of promises
$\fprom{i}{a}{b}$, $\bprom{i}{a}{b}{b'}$ and $\mprom{i}{a}{b}$ according to its
past behaviour. Each phase II instance $i$ operates just as in the Synod
algorithm, starting with a broadcast of $\prop{i}{b}$ to which each node $a$
may respond with an acceptance $\acc{i}{a}{b}$ and once acceptances have been
received from a quorum of nodes it follows that $\chosen{i}{b}$ holds.

There is a function $v_i : \mathbb B \to \mathbb V$ for each instance $i$
giving a value to each ballot, and theorem \ref{paxos-safety-theorem} shows
that whenever $\chosen{i}{b}$ and $\chosen{i}{b'}$ it follows that $v_i(b) =
v_i(b')$.

The invariants listed in appendix \ref{paxos-invariants} are roughly the same
as for many other presentations of Paxos with the addition of constraints on
the eras of instances and ballots as discussed below. Note that invariants
\ref{paxos-mprom}, \ref{paxos-fprom} and \ref{paxos-bprom} limit the
acceptances that can be sent as well as the promises, so there is no need to
define separate invariants concerning the sending of acceptances.

\subsection{Configuration changes}\label{configuration-changes}

A fixed cluster configuration is a pair $\langle \QI{}, \QII{} \rangle$ of sets
of quorums satisfying $\QI{} \frown \QII{}$, where $\QI{}$ and $\QII{}$ are
respectively the sets of phase-I and phase-II quorums in use.  Changes to the
cluster configuration are modelled by a sequence of configurations $ \langle
\QI{0}, \QII{0} \rangle, \langle \QI{1}, \QII{1} \rangle, \ldots$ that also
satisfy $\QI{e} \frown \QII{e+1}$ for all $e$.  The integer subscript is called
the \textit{era} of a configuration.  Intuitively the cluster is ``in era $e$''
while instances are being chosen using $\langle \QI{e}, \QII{e}\rangle$. While
a change from era $e$ to $e+1$ is in progress some instances may use the
interim configuration $\langle \QI{e}, \QII{e+1} \rangle$ and once the change
to era $e+1$ is complete instances will use $\langle \QI{e+1}, \QII{e+1}
\rangle$. Since $\QII{e} \frown \QI{e} \frown \QII{e+1} \frown \QI{e+1}$ it
follows that consistency is preserved throughout by the observation of
\ref{per-phase-quorums} above.

To achieve this there are also two nondecreasing integer-valued functions, both
written $e(\cdot)$, which respectively assign an era $e(i)$ to each instance
$i$, and an era $e(b)$ to each ballot $b$. Intuitively $e(b)$ records which
quorums may be used to decide that $\prop{i}{b}$ can be sent in phase I and
$e(i)$ records which quorums may be used to decide that $\chosen{i}{b}$ holds
in phase II. More precisely a node may emit $\prop{i}{b}$ only if $e(b) \le
e(i)$ and it has received promises for ballot $b$ in instance $i$ from a quorum
of nodes in $\QI{e(b)}$, and similarly a node may decide $\chosen{i}{b}$ only
if ${e(i) \le e(b)+1}$ and it has received $\acc{i}{a}{b}$ from a quorum of
nodes in $\QII{e(i)}$. These extra conditions ensure that if $\chosen{i}{b}$
then ${e(b) \le e(i) \le e(b)+1}$ and hence $\QI{e(b)} \frown \QII{e(i)}$ as
required to ensure consistency.

\subsection{Dynamic configuration changes}

As in Dynamic Paxos, the configurations $\langle \QI{0}, \QII{0} \rangle,
\langle \QI{1}, \QII{1} \rangle, \ldots$ and era numbers $e(i)$ are themselves
chosen by consensus. In more detail, configurations are tracked by a state
machine whose state is the finite sequence $\langle \QI{0}, \QII{0} \rangle,
\ldots, \langle \QI{e_\mathrm{max}}, \QII{e_\mathrm{max}} \rangle$ and the era
numbers of instances are tracked by a state machine whose state is the finite
nondecreasing sequence $e(0), \ldots, e(i_\mathrm{max})$.  Their transitions
append one or more elements to these sequences, but do not change any existing
elements, and the tracked sequences are always long enough to make progress in
the sense that if $\chosen{i}{b}$ then they satisfy $i_\mathrm{max} > i$ and
$e_\mathrm{max} \ge e(i_\mathrm{max})$. Era numbers $e(b)$ for ballots $b$ are
fixed in advance and not chosen by consensus.

\subsection{Liveness}\label{liveness}

To be useful this algorithm must not only guarantee consistency but also ensure
that it is always possible to make progress by eventually choosing a value for
each instance. It is impossible to show this deterministically in a fully
asynchronous system\cite{flp-impossibility} but as with earlier presentations
of Paxos\cite{paxos-made-simple} here liveness can be proved by assuming that a
distinguished node $\ell$ is eventually selected as the only one that may emit
$\prep{b}$ messages. The original liveness proof then proceeded by having
$\ell$ emit $\prep{b}$ for some $b$ that is chosen to be large enough that a
quorum of nodes may respond with promises. Unlike in the original proof, here
there is an upper bound on suitable ballots, because if ${e(b) > e(i)}$ then
$\prop{i}{b}$ may never be sent and nor may $\prop{i}{b'}$ for any $b' \succ b$
since $e(\cdot)$ is nondecreasing.  Therefore here $\ell$ must be able to
choose a ballot that is large enough but not too large.  More precisely, this
requires that for each ballot $b$, each era $e \ge e(b)$ and each node $a$
there must be a ballot $b' \succ b$ having $e(b') = e$ and $\owner{b'} = a$.
This means that ballot numbers cannot be simple integers because this would
imply that all eras (except at most one) have only finitely many ballots.
Rather than using simple integers one could, for example, let $\mathbb B =
\mathbb N \times \mathbb N \times \mathbb A$ ordered lexicographically, where
$e(\langle e, n, a\rangle) = e$ and $\owner{\langle e, n, a \rangle} = a$. This
is the approach used in Egalitarian Paxos\cite{egalitarian-paxos} in which eras
are known as \textit{epochs} but this terminology is avoided here to prevent
confusion with the epochs (views, terms, \ldots) of leader-election protocols
which track the current leader rather than the current configuration.

It is also necessary to limit the promises made to only those where $e(b) \le
e(i)$ because if node $a$ made a promise $\fprom{i}{a}{b}$ with $e(b) > e(i)$
then it can no longer accept any proposals $\prop{i}{b'}$ since such a proposal
would have $e(b') \le e(i) < e(b)$ so that $b' \prec b$. As changes to the
current era are themselves agreed by consensus this may prevent any further
progress from being made.

With these two modifications the proof of liveness runs much as in the original
presentation:

\begin{theorem}[Liveness] Given that there is eventually a non-faulty
distinguished node $\ell$ which is the only node that may emit messages of the
form $\prep{b}$, and given that for every instance there is eventually at least
one value to propose, eventually a value is chosen for every instance.
\end{theorem}

\begin{proof} The proof proceeds by induction over the instances, so suppose
that $\chosen{j}{b_j}$ for all $j < i$ and show that eventually
$\chosen{i}{b_i}$ as follows.

Firstly note that $i \le i_{\mathrm{max}}$ since either $i = 0$ or
$\chosen{i-1}{b_{i-1}}$ and hence that $e(i)$ is known to $\ell$. Recall also
that $e(i_{\mathrm{max}}) \le e_{\mathrm{max}}$ and hence that $\QI{e(i)-1}$,
$\QI{e(i)}$ and $\QII{e(i)}$ are known to $\ell$.

The distinguished node $\ell$ first chooses a ballot $b_i$ having $e(b_i) \in
\{ e(i) - 1, e(i) \}$ and $\owner{b_i} = \ell$ and such that enough nodes can
emit $\acc{i}{a}{b_i}$ without breaking any promises. Such a $b_i$ exists as
noted above.

If $\ell$ has not yet received enough promises for $b_i$ at instance $i$ then
it broadcasts $\prep{b_i}$ and waits to receive promises from a quorum of nodes
in $\QI{e(b_i)}$.

Then, if $\ell$ has not yet emitted $\prop{i}{b_i}$ it chooses one of the
values for instance $i$ (which eventually exists), modifies $v_i(b_i)$ as
appropriate, broadcasts $\prop{i}{b_i}$, and waits to receive acceptances from
a quorum of nodes in $\QII{e(i)}$. When enough acceptances have been received
it follows that $\chosen{i}{b_i}$ as required. \end{proof}

\subsection{Fully concurrent configuration changes}\label{fully-concurrent}

In normal running there is an instance $i_0$ and a ballot $b$ with ${e(b) =
e(i_0) = e(i_\mathrm{max}) = e_\mathrm{max}}$ and the distinguished node $\ell
= \owner{b}$ has received a quorum of promises $q^\textrm{I} \in \QI{e(b)}$ for
ballot $b$ for all instances $i \ge i_0$. In this state, $\ell$ may emit
$\prop{i}{b}$ for any $i \ge i_0$, since $e(b) = e(i_0) \le e(i)$ as $e$ is
nondecreasing.  The node $\ell$ is known as the \textit{leader} and its
proposals are normally accepted without undue delay by all other nodes.

\def\Qnew#1{Q^\textrm{#1}_\textrm{new}}

When in this state it is possible to perform a reconfiguration without
preventing any other proposals from being made and values chosen concurrently
using the following procedure. Suppose an operator wishes to change the cluster
configuration to $\langle \Qnew{I}, \Qnew{II} \rangle$ where $\QI{e(b)} \frown
\Qnew{II} \frown \Qnew{I}$. First she appends $\langle \Qnew{I}, \Qnew{II}
\rangle$ to the sequence of configurations, setting $\langle \QI{e(b)+1},
\QII{e(b)+1} \rangle = \langle \Qnew{I}, \Qnew{II} \rangle$ and $e_\mathrm{max}
= e(b) + 1$, then she picks a future instance $i_c > i_\mathrm{max}$ at which
the change should take effect and appends values to the sequence of eras to set
$e(i) = e(i_0)$ for $i_0 \le i < i_c$ and $e(i_c) = e(i_0) + 1$.  Since $e(i_c)
= e(i_0) + 1 \le e(b) + 1$, values for instance $i_c$ and any future instances
with the same era may be proposed and chosen even though phase I has not yet
run for a ballot in this era. As long as $e(i_\mathrm{max})$ is not increased
again, this means there is no limit on how many further instances can be
proposed and chosen without waiting for another phase I to complete.

At this point, the system is no longer in normal running as defined above
because $e(b) = e_\mathrm{max} - 1$. In order to get back to normal running
without limiting concurrency, a ballot $b'$ should be chosen with $e(b') = e(b)
+ 1$ and $\owner{b'}$ should try and obtain a quorum of promises for $b'$
without preventing progress in era $e(b)$. It can do this by dividing the
cluster into two quorums in such a way that it has a \textit{casting vote}
between the two quorums: it finds $q \in Q_{e(b)}$ and $q' \in Q_{e(b)+1}$
having $q \cap q' = \{\owner{b'}\}$ and broadcasts $\prep{b'}$ to all nodes in
$q'$ except itself. While it is waiting for the promises to arrive in response
to this broadcast, $\owner{b}$ continues to make progress choosing instances of
ballot $b$ using the quorum $q \in Q_{e(b)}$.  Eventually when promises have
arrived from every node in $q'$ except $\owner{b'}$ itself, it can send itself
a final promise, immediately complete phase I for ballot $b'$, and start
broadcasting proposals $\prop{i}{b'}$.  This restores the system to normal
running. Observe the following:
%
\begin{itemize}
%
\item The first part of this process requires that $e(i_\mathrm{max})$
increases by at most $1$ before the new phase I has finished running, because
if $e(i_\mathrm{max}) \ge e(i_0) + 2$ then no values may be chosen for any
instance $i \ge i_\mathrm{max}$ without running another phase I, which bounds
how many instances may be running concurrently. In this situation consistency
and liveness are preserved but there may be a performance impact.
%
\item The second part of this process requires the existence of a node
$\owner{b'}$ that has a casting vote. If $\owner{b} \ne \owner{b'}$ then this
step includes an \textit{abdication}: the original leader $\owner{b}$ hands
over the leadership of the cluster to $\owner{b'}$. If there is no node with a
casting vote then the broadcast of $\prep{b'}$ will prevent further progress in
era $e(b)$. Again, this preserves consistency and liveness but may limit
performance.
%
\item If a node fails during this process then it may be necessary to retry
some of the steps or possibly even elect a new leader. Again, this preserves
consistency and liveness but may limit performance. In general it is not
possible to prevent a failure from having an impact on the performance of the
system.
%
\end{itemize}

\subsection{Examples}\label{types-of-configuration-change}

This section contains some examples of configuration changes that satisfy the
conditions described above.  All the configurations described here have equal
sets of quorums in phase I and phase II in normal running, so for the sake of
simplicity throughout this section let $Q^\textrm{I}_e = Q^\textrm{II}_e$ and
write simply $Q_e$ for both. Implementations can ensure $Q_e \frown Q_e$ for
each $e$ by, for instance, arranging for each quorum in $Q_e$ to comprise a
majority subset of some finite set of nodes. Slightly more generally, let a
\textit{weight function} be a function $w : \mathbb A \to \mathbb N$ that only
takes finitely many nonzero values. This can be used to define a configuration
$\langle M(w), M(w) \rangle$ by \textit{weighted majority}: \[M(w) = \left\{ q
\;\middle|\; \sum_{a \in q} 2 w(a) > \sum_{a \in \mathbb A} w(a) \right\}.\]
Corollary \ref{weights-equal} in appendix \ref{weights-appendix} demonstrates
the well-known result that $M(w) \frown M(w)$ for any weight function $w$.
Indeed, if $w$ and $w'$ are weight functions that differ by a constant factor
in the sense that that there are positive integers $k$ and $k'$ with $k w(a) =
k' w'(a)$ for all $a$, then clearly ${M(w) = M(w')}$ and hence $M(w) \frown
M(w')$.

\def\wl#1{w^{1 \ldots #1}}
\def\Mwl#1{M(\wl{#1})}

Raft's quorums are simple unweighted majorities of a finite set of nodes, which
can be emulated with weight functions that only take values in $\{0, 1\}$. It
only supports adding or removing a single node from this set which amounts to
changing the weight of a single node by $1$. For instance, if $\mathbb A = \{
a_1, a_2, \ldots \}$ then define weight functions \[\wl{n}(a) = \begin{cases} 1
& \mathrm{if } a \in \{a_1, \ldots, a_n\} \\ 0 &
\mathrm{otherwise}\end{cases}\] and observe that ${\Mwl{3} \frown \Mwl{4}}$ and
${\Mwl{4} \frown \Mwl{5}}$ but ${\Mwl{3} \not\frown \Mwl{5}}$ because $\{a_1,
a_2\} \in \Mwl{3}$ and $\{a_3, a_4, a_5\} \in \Mwl{5}$ do not intersect. This
justifies the restriction against adding or removing more than one node at
once.

In fact there is no need to restrict attention just to weight functions taking
values in $\{0, 1\}$ as shown by theorem \ref{weights-nearly-equal} which is
reminiscent of the amoeba analogy in \cite{cheap-paxos}: any two weight
functions that differ by at most one at at most one node can be used to define
consecutive configurations. This extra generality is important for deployments
where nodes may share infrastructure (e.g. power distribution or network
connectivity) because such nodes may suffer correlated failures, and reducing
this correlation tends to be expensive.  In more detail, a na\"ive approach to
swapping a node $a_{\textrm{old}}$ for a replacement $a_{\textrm{new}}$ in a
three-node cluster using unweighted majorities would be to perform the
configuration changes given by this sequence of weight functions:
\[\begin{array}{rcccc}
%
\textrm{node}&a_{\textrm{old}}&a_{\textrm{new}}&a_1&a_2 \\
%
w_e&1&0&1&1\\
%
w_{e+1}&1&1&1&1\\
%
w_{e+2}&0&1&1&1\\
%
\end{array}\]
%
However to be resilient to infrastructure failures this requires all four nodes
and their underlying infrastructures to be completely independent since a
correlated failure of any two nodes would prevent further progress.  It also
has no node with a casting vote in era $e+1$. On the other hand the following
sequence achieves the same overall change but allows $a_{\textrm{old}}$ and
$a_{\textrm{new}}$ to share infrastructure without extra risk, and both $a_1$
and $a_2$ have casting votes throughout: \[\begin{array}{rcccc}
%
\textrm{node}&a_{\textrm{old}}&a_{\textrm{new}}&a_1&a_2 \\
%
w_e&1&0&1&1\\
%
w_{e+1}&2&0&2&2\\
%
w_{e+2}&2&1&2&2\\
%
w_{e+3}&1&1&2&2\\
%
w_{e+4}&0&1&2&2\\
%
w_{e+5}&0&2&2&2\\
%
w_{e+6}&0&1&1&1\\
%
\end{array}\]
%
This is important as in many operating environments it may be too expensive or
complicated to arrange for four independent infrastructures particularly if the
fourth is only required to ensure consistency in relatively rare periods of
maintenance. For instance at time of writing only one Amazon Web Services
region (\texttt{us-east-1}) has four independent zones, whereas four of them
have three: \texttt{ap-southeast-2}, \texttt{eu-west-1}, \texttt{sa-east-1} and
\texttt{us-west-2}. Similarly, only one Google Cloud Platform region
(\texttt{us-central1}) has four zones and all the others have three zones.

Early versions of Raft supported more general reconfigurations using a
technique known as \textit{joint configurations}. To change from configuration
$Q_{e}$ to an unrelated configuration $Q'$ (i.e.  $Q_{e} \not\frown Q' \frown
Q'$) it is possible to set $Q_{e+2} = Q'$ and set $Q_{e+1}$ to be the
\textit{joint configuration} of $Q_{e}$ and $Q'$: \[Q_{e+1} = \{ q \cup q' \mid
q \in Q_{e}, q' \in Q' \}.\] Intuitively, while this joint configuration is in
use all decisions must be agreed by quorums of both the old and new
configuration. Certainly this satisfies that \[Q_{e} \frown Q_{e + 1} \frown
Q_{e+1} \frown Q_{e + 2} \frown Q_{e + 2}.\]

If $w(a) = 0$ for all $a$ then $w$ is said to be \textit{weightless} and $M(w)
= \varnothing$. Clearly if there is an instance $i$ such that $Q_{e(i)} =
\varnothing$ then no value can ever be chosen for $i$. On the other hand $Q
\frown \varnothing$ for all $Q$ so changing to a weightless configuration is
always permitted, and this has the effect of stopping a Paxos cluster at a
particular instance \cite{reconfiguring-a-state-machine,stoppable-paxos}.

There is no requirement for the eras of consecutive instances to differ by at
most one so an era may be skipped at instance $i$ by letting $e(i) = e(i-1) +
2$.  This recovers the ability to perform arbitrary configuration changes in a
single step as in Dynamic Paxos. In more detail, if the system is currently
using configuration $Q_{e}$ and an operator wishes to change to an unrelated
configuration $Q'$ then she can set $Q_{e+2} = Q'$ and pick an appropriate
$Q_{e+1}$ such as $\varnothing$ or the joint configuration of $Q_{e}$ and $Q'$
which satisfies that $Q_{e} \frown Q_{e + 1} \frown Q_{e+1} \frown Q'$.
However, re-running phase I can only be delayed as described in section
\ref{fully-concurrent} above if the era increases by $1$ and in this situation
the era increases by $2$, so the new phase I must be complete before any new
phase II instances can be started.  To prevent this causing the pipeline to
stall, the operator chooses an $\alpha > 0$ and sets $e(i+\alpha) = e(i)+2$ and
$e(j) = e(i)$ for $i < j \le i + \alpha$, effectively delaying the
configuration change for $\alpha$ instances in the hope that this is long
enough to have completed the new phase I. This improves slightly on Dynamic
Paxos as there is no need to limit the pipeline length unless a configuration
change is in progress, and different changes may use different values of
$\alpha$ if required.

\section{Related Work}

As discussed above, the approach described here generalises Dynamic
Paxos\cite{cheap-paxos} to support changing the pipeline length parameter
$\alpha$ and running with an unlimited-length pipeline while a configuration
change is not in progress. It also supports Raft-style
reconfigurations\cite{raft} which can be performed with an unlimited pipeline
throughout, and implements the ``brick-wall'' stopping scheme as in Stoppable
Paxos\cite{stoppable-paxos}. Unlike in Stoppable Paxos, here an instance can be
chosen only if the previous instances have also all been chosen. This could be
an acceptable restriction in many situations.

It achieves equivalent goals to those of Vertical Paxos\cite{vertical-paxos}
except that here there is no requirement for a separate oracle to manage the
configuration of the system.  Egalitarian Paxos\cite{egalitarian-paxos} also
defines a nondecreasing $e(b)$ for each ballot $b$ to ensure that ballots are
not chosen when their configuration is stale, and as with Vertical Paxos these
values are managed externally. The problem with an external oracle is that for
full resilience it must be possible to reconfigure the oracle itself, which
requires another oracle and so on \textit{ad infinitum}.

It is also noted that there is no need for every node to receive (even a hash
of) every value that is proposed, which may allow for even cheaper
implementations of Cheap Paxos\cite{cheap-paxos} and can simplify the transfer
of state\cite{vertical-paxos} required when new nodes are commissioned.

An interesting alternative approach is proposed by Jahl and
Meling\cite{async-reconfig} which uses eventual consistency rather than
consensus to determine the configuration of the system, and therefore supports
reconfiguration as long as it is still possible to communicate with a quorum of
nodes even if consensus cannot be achieved due to an inability to elect a
distinguished leader. In such a situation consensus-based approaches such as
the one presented here would fail to make any further progress, whereas one
based on eventual consistency could be reconfigured into one in which a leader
may be elected and thus in which further progress can be made.


% An example of a floating figure using the graphicx package.
% Note that \label must occur AFTER (or within) \caption.
% For figures, \caption should occur after the \includegraphics.
% Note that IEEEtran v1.7 and later has special internal code that
% is designed to preserve the operation of \label within \caption
% even when the captionsoff option is in effect. However, because
% of issues like this, it may be the safest practice to put all your
% \label just after \caption rather than within \caption{}.
%
% Reminder: the "draftcls" or "draftclsnofoot", not "draft", class
% option should be used if it is desired that the figures are to be
% displayed while in draft mode.
%
%\begin{figure}[!t]
%\centering
%\includegraphics[width=2.5in]{myfigure}
% where an .eps filename suffix will be assumed under latex, 
% and a .pdf suffix will be assumed for pdflatex; or what has been declared
% via \DeclareGraphicsExtensions.
%\caption{Simulation results for the network.}
%\label{fig_sim}
%\end{figure}

% Note that the IEEE typically puts floats only at the top, even when this
% results in a large percentage of a column being occupied by floats.


% An example of a double column floating figure using two subfigures.
% (The subfig.sty package must be loaded for this to work.)
% The subfigure \label commands are set within each subfloat command,
% and the \label for the overall figure must come after \caption.
% \hfil is used as a separator to get equal spacing.
% Watch out that the combined width of all the subfigures on a 
% line do not exceed the text width or a line break will occur.
%
%\begin{figure*}[!t]
%\centering
%\subfloat[Case I]{\includegraphics[width=2.5in]{box}%
%\label{fig_first_case}}
%\hfil
%\subfloat[Case II]{\includegraphics[width=2.5in]{box}%
%\label{fig_second_case}}
%\caption{Simulation results for the network.}
%\label{fig_sim}
%\end{figure*}
%
% Note that often IEEE papers with subfigures do not employ subfigure
% captions (using the optional argument to \subfloat[]), but instead will
% reference/describe all of them (a), (b), etc., within the main caption.
% Be aware that for subfig.sty to generate the (a), (b), etc., subfigure
% labels, the optional argument to \subfloat must be present. If a
% subcaption is not desired, just leave its contents blank,
% e.g., \subfloat[].


% An example of a floating table. Note that, for IEEE style tables, the
% \caption command should come BEFORE the table and, given that table
% captions serve much like titles, are usually capitalized except for words
% such as a, an, and, as, at, but, by, for, in, nor, of, on, or, the, to
% and up, which are usually not capitalized unless they are the first or
% last word of the caption. Table text will default to \footnotesize as
% the IEEE normally uses this smaller font for tables.
% The \label must come after \caption as always.
%
%\begin{table}[!t]
%% increase table row spacing, adjust to taste
%\renewcommand{\arraystretch}{1.3}
% if using array.sty, it might be a good idea to tweak the value of
% \extrarowheight as needed to properly center the text within the cells
%\caption{An Example of a Table}
%\label{table_example}
%\centering
%% Some packages, such as MDW tools, offer better commands for making tables
%% than the plain LaTeX2e tabular which is used here.
%\begin{tabular}{|c||c|}
%\hline
%One & Two\\
%\hline
%Three & Four\\
%\hline
%\end{tabular}
%\end{table}


% Note that the IEEE does not put floats in the very first column
% - or typically anywhere on the first page for that matter. Also,
% in-text middle ("here") positioning is typically not used, but it
% is allowed and encouraged for Computer Society conferences (but
% not Computer Society journals). Most IEEE journals/conferences use
% top floats exclusively. 
% Note that, LaTeX2e, unlike IEEE journals/conferences, places
% footnotes above bottom floats. This can be corrected via the
% \fnbelowfloat command of the stfloats package.




\appendices

\section{}\label{weights-appendix}

\begin{theorem} \label{weights-nearly-equal} If $w, w' : \mathbb A \to \mathbb
N$ are weight functions such that $\sum_{a \in \mathbb A} |w'(a) - w(a)| \le 1$
then $M(w) \frown M(w')$.  \end{theorem}

\begin{proof}Since $w$ and $w'$ take integer values, they must differ at at
most one node by at most $1$. Let $a_0$ be the node such that $|w'(a_0) -
w(a_0)| \le 1$ and $w(a) = w'(a)$ for all $a \ne a_0$.
%
Let $q \in M(w)$ and $q' \in M(w')$. By the definition of $M$, and since $w$
and $w'$ take only integer values,
%
$\sum_{a \in q} 2 w(a) \ge \sum_{a \in \mathbb A} w(a) + 1$
%
and
%
$\sum_{a \in q'} 2 w'(a) \ge \sum_{a \in \mathbb A} w'(a) + 1$.
%
Let $d_{\mathbb A} = w'(a_0) - w(a_0)$ so that $\sum_{a \in \mathbb A} w'(a) =
\sum_{a \in \mathbb A} w(a) + d_{\mathbb A}$ and $|d_\mathbb A| \le 1$. Also
let \[ d_{q'} =
\begin{cases}
%
d_{\mathbb A} & a_0 \in q' \\
%
0 & \textrm{otherwise,}
%
\end{cases}
\]
so that $\sum_{a \in q'} w'(a) = \sum_{a \in q'} w(a) + d_{q'}$.
%
Then
%
\[\begin{split}
%
\sum_{a \in \mathbb A} 2w(a) &+ d_{\mathbb A} + 2 \\
%
&= \left( \sum_{a \in \mathbb A} w(a)  + 1\right)
+  \left( \sum_{a \in \mathbb A} w'(a) + 1\right) \\
%
&\le \sum_{a \in q}  2w(a)
+    \sum_{a \in q'} 2w'(a) \\
%
&= \sum_{a \in q}  2w(a)
+  \sum_{a \in q'} 2w(a) + 2d_{q'}\\
%
&= \sum_{a \in q \cup q'} 2w(a)
+  \sum_{a \in q \cap q'} 2w(a) + 2d_{q'}\\
%
&\le \sum_{a \in \mathbb A} 2w(a)
+    \sum_{a \in q \cap q'} 2w(a) + 2d_{q'}\\
%
\end{split}\] so that $\sum_{a \in q \cap q'} 2w(a) \ge d_{\mathbb
A} + 2 - 2d_{q'} = 2 \pm d_\mathbb A \ge 1$ and hence $q \cap q' \ne
\varnothing$ as desired.  \end{proof}

\begin{corollary} \label{weights-equal} If $w : \mathbb A \to \mathbb N$ is a
weight function then \[M(w) \frown M(w).\]  \end{corollary}

\begin{proof} This is a special case of theorem \ref{weights-nearly-equal},
where $w' = w$.  \end{proof}


\vfill

\pagebreak

\section{Consistency of the Synod algorithm}
\label{synod-safety}

The consistency property of the Synod algorithm is derived from the following
invariants.

\begin{enumerate}

\item \label{synod-quorums} For $b_1 \succ b_2 \in \mathbb B$ there are sets of
quorums $Q^\textrm{I}(b_1)$ and $Q^\textrm{II}(b_2) \subseteq \mathcal P
\mathbb A$ such that if $\prop{}{b_1}$ and $\chosen{}{b_2}$ then
${Q^\textrm{I}(b_1) \frown Q^\textrm{II}(b_2)}$.

\item \label{synod-fprom} $\fprom{}{a}{b}$ only if $\neg\acc{}{a}{b'}$ for ${b'
\prec b}$.

\item \label{synod-bprom} $\bprom{}{a}{b}{b'}$ only if $b' \prec b$,
$\acc{}{a}{b'}$, and $b'$ is the greatest such ballot, in the sense that
$\neg\acc{}{a}{b''}$ for all $b''$ having $b' \prec b'' \prec b$.

\item \label{synod-prop} $\prop{}{b}$ only if there is $q^\textrm{I} \in
Q^\textrm{I}(b)$ such that for every node $a \in q^\textrm{I}$ either
$\fprom{}{a}{b}$ or else $\exists b'.  \bprom{}{a}{b}{b'}$, and if ${P = \{ b'
\mid \exists a \in q^\textrm{I}. \bprom{}{a}{b}{b'} \} \ne \varnothing}$ then
it follows that $v(b) = v(\mathrm{max}(P))$.

\item \label{synod-acc} $\acc{}{a}{b}$ only if $\prop{}{b}$.

\item \label{synod-chosen} $\chosen{}{b}$ only if there is $q^\textrm{II} \in
Q^\textrm{II}(b)$ such that $\acc{}{a}{b}$ for every $a \in q^\textrm{II}$.

\end{enumerate}

\begin{lemma}\label{synod-acc-bprom}If $\acc{}{a}{b_2}$,
$\bprom{}{a}{b_1}{b_3}$ and $b_2 \prec b_1$ then $b_2 \preceq b_3$.\end{lemma}

\begin{proof} From invariant \ref{synod-bprom} it follows that $b_3$ is the
largest ballot such that $b_3 \prec b_1$ and $\acc{}{a}{b_3}$, but $b_2$ is
also such a ballot and therefore $b_2 \preceq b_3$ as required.  \end{proof}

\begin{lemma}\label{synod-lemma} If $\chosen{}{b_2}$, $\prop{}{b_1}$ and $b_2
\prec b_1$ then $v(b_1) = v(b_2)$. \end{lemma}

\begin{proof}Suppose for a contradiction that $v(b_1) \ne v(b_2)$ and since
$\prec$ is wellfounded suppose without loss of generality that $b_1$ is the
minimal such ballot.  Since $\chosen{}{b_2}$ by invariant \ref{synod-chosen}
there is a quorum $q^\textrm{II} \in Q^\textrm{II}(b_2)$ such that
$\acc{}{a}{b_2}$ for every $a \in q^\textrm{II}$.  By invariant
\ref{synod-fprom} it cannot be that $\fprom{}{a}{b_1}$ for any $a \in
q^\textrm{II}$.  Also since $\prop{}{b_1}$ by invariant \ref{synod-prop} there
is a quorum $q^\textrm{I} \in Q^\textrm{I}(b_1)$ such that either
$\fprom{}{a}{b_1}$ or $\exists b'.  \bprom{}{a}{b_1}{b'}$ for all $a \in
q^\textrm{I}$.  Let $P = \{ b' \mid \exists a \in q^\textrm{I}.
\bprom{}{a}{b_1}{b'} \}$.  By invariant \ref{synod-quorums},
${Q^\textrm{I}(b_1) \frown Q^\textrm{II}(b_2)}$ and hence $q^\textrm{I} \cap
q^\textrm{II} \ne \varnothing$ so it follows that $P \ne \varnothing$, which
means that $v(b_1) = v(\mathrm{max}(P))$ by invariant \ref{synod-prop}. Let
$a_{\mathrm{max}} \in q^\textrm{I}$ be such that
$\bprom{}{a_{\mathrm{max}}}{b_1}{\mathrm{max}(P)}$.  By invariant
\ref{synod-bprom} it follows that $\mathrm{max}(P) \prec b_1$ and also that
$\acc{}{a_{\mathrm{max}}}{\mathrm{max}(P)}$ and hence
$\prop{}{\mathrm{max}(P)}$ by invariant \ref{synod-acc}. Furthermore by lemma
\ref{synod-acc-bprom} it follows that $b_2 \preceq \mathrm{max}(P)$ and since
$b_1$ was assumed to be the smallest counterexample it must be that
$v(\mathrm{max}(P)) = v(b_2)$.  Hence $v(b_1) = v(b_2)$ which is a
contradiction as required.  \end{proof}

\begin{theorem}\label{synod-safety-theorem} If $\chosen{}{b_1}$ and
$\chosen{}{b_2}$ then $v(b_1) = v(b_2)$.  \end{theorem}

\begin{proof} Without loss of generality assume that ${b_2 \prec b_1}$. By
invariant \ref{synod-chosen} there is a quorum $q \in Q^\textrm{II}(b_1)$ such
that $\acc{}{a}{b_1}$ for every node $a \in q$ and therefore $\prop{}{b_1}$ by
invariant \ref{synod-acc}.  Therefore by lemma \ref{synod-lemma} it follows
that $v(b_1) = v(b_2)$ as required.  \end{proof}

\section{Consistency of the Paxos algorithm}\label{paxos-invariants}

The consistency property of the Paxos algorithm is derived from the following
invariants.

\begin{enumerate}

\item\label{paxos-quorums} There are configurations $\langle \QI{0}, \QII{0}
\rangle, \langle \QI{1}, \QII{1} \rangle, \ldots$ where ${\QII{e} \frown \QI{e}
\frown \QII{e+1}}$ for each $e$.

\item\label{paxos-mprom} $\mprom{i}{a}{b}$ only if $\neg\acc{i'}{a}{b'}$ for
all $i' \ge i$ and $b' \prec b$, and $e(b) \le e(i)$.

\item\label{paxos-fprom} $\fprom{i}{a}{b}$ only if $\neg\acc{i}{a}{b'}$ for all
$b' \prec b$, and $e(b) \le e(i)$.

\item\label{paxos-bprom} $\bprom{i}{a}{b}{b'}$ only if \begin{itemize} \item
$e(b) \le e(i)$, \item $b' \prec b$, \item $\acc{i}{a}{b'}$, and \item $b'$ is
the greatest such ballot, in the sense that $\neg \acc{i}{a}{b''}$ for all
$b''$ having $b' \prec b'' \prec b$. \end{itemize}

\item\label{paxos-prop} $\prop{i}{b}$ only if there is a $q \in \QI{e(b)}$ such
that
\begin{itemize}
\item for every $a \in q$ one of the following holds:
%
\begin{itemize}
\item $\mprom{i'}{a}{b}$ for some $i' \le i$, or
\item $\fprom{i}{a}{b}$, or
\item $\bprom{i}{a}{b}{b'}$ for some $b'$, and
\end{itemize}

\item if $P = \{ b' \mid \exists a \in q. \bprom{i}{a}{b}{b'} \} \ne
\varnothing$ then $v_i(b) = v_i(\mathrm{max}(P))$.

\end{itemize}

\item \label{paxos-acc} $\acc{i}{a}{b}$ only if $\prop{i}{b}$.

\item \label{paxos-chosen} $\chosen{i}{b}$ only if \begin{itemize} \item for
each $j < i$ there is a $b'$ with $\chosen{i-1}{b'}$, \item $e(i) \le e(b) +
1$, and \item there is a quorum $q \in \QII{e(i)}$ with $\acc{i}{a}{b}$ for
every $a \in q$.  \end{itemize}

\end{enumerate}

\begin{lemma}\label{paxos-synod-quorum-invariant} For $b_1 \succ b_2 \in
\mathbb B$, if $\prop{i}{b_1}$ and $\chosen{i}{b_2}$ then
${\QI{e(b_1)} \frown \QII{e(i)}}$.  \end{lemma}

\begin{proof} $\prop{i}{b_1}$ implies that $\mprom{i'}{a}{b_1}$ or
$\fprom{i'}{a}{b_1}$ or $\bprom{i'}{a}{b_1}{b'}$ for some node $a$ and some $i'
\le i$. Therefore $e(i) \le e(b_2) + 1 \le e(b_1) + 1 \le e(i') + 1 \le e(i) +
1$ since $\chosen{i}{b_2}$ and $e$ is nondecreasing so that $e(i) \in \{
e(b_1), e(b_1) + 1 \}$ and hence ${\QI{e(b_1)} \frown \QII{e(i)}}$ by invariant
\ref{paxos-quorums}.  \end{proof}

\begin{theorem}\label{paxos-safety-theorem} If $\chosen{i}{b_1}$ and
$\chosen{i}{b_2}$ then ${v_i(b_1) = v_i(b_2)}$.  \end{theorem}

\begin{proof} If $\chosen{i}{b_1}$ then the Paxos invariants imply the Synod
invariants for instance $i$.  In more detail, let
\[\begin{array}{rl}
Q^\textrm{I}(b) &= \QI{e(b)}, \\
Q^\textrm{II}(b) &= \QII{e(i)}, \\
\fprom{}{a}{b} &= \fprom{i}{a}{b} \\
& \ {}\vee \exists i' \le i. \mprom{i'}{a}{b}, \\
\bprom{}{a}{b}{b'} &= \bprom{i}{a}{b}{b'}, \\
\prop{}{b} &= \prop{i}{b}, \\
\acc{}{a}{b} &= \acc{i}{a}{b}, \\
\chosen{}{b} &= \chosen{i}{b} \textrm{ and} \\
v(b) &= v_i(b) .\\
\end{array}
\]
Synod's invariant \ref{synod-quorums} follows from lemma
\ref{paxos-synod-quorum-invariant} and the remaining invariants are simple to
show so by theorem \ref{synod-safety-theorem} it follows that $v_i(b_1) =
v_i(b_2)$ as required.  \end{proof}

% use section* for acknowledgment
\section*{Acknowledgment}

The author would like to thank Leslie Lamport, Dahlia Malkhi and Leander
Nikolaus Jehl for their advice and comments on earlier drafts of this paper.



% Can use something like this to put references on a page
% by themselves when using endfloat and the captionsoff option.
\ifCLASSOPTIONcaptionsoff
  \newpage
\fi



% trigger a \newpage just before the given reference
% number - used to balance the columns on the last page
% adjust value as needed - may need to be readjusted if
% the document is modified later
%\IEEEtriggeratref{8}
% The "triggered" command can be changed if desired:
%\IEEEtriggercmd{\enlargethispage{-5in}}

% references section

% can use a bibliography generated by BibTeX as a .bbl file
% BibTeX documentation can be easily obtained at:
% http://mirror.ctan.org/biblio/bibtex/contrib/doc/
% The IEEEtran BibTeX style support page is at:
% http://www.michaelshell.org/tex/ieeetran/bibtex/
\bibliographystyle{IEEEtran}
% argument is your BibTeX string definitions and bibliography database(s)
\bibliography{paxos}
%
% <OR> manually copy in the resultant .bbl file
% set second argument of \begin to the number of references
% (used to reserve space for the reference number labels box)

% biography section
% 
% If you have an EPS/PDF photo (graphicx package needed) extra braces are
% needed around the contents of the optional argument to biography to prevent
% the LaTeX parser from getting confused when it sees the complicated
% \includegraphics command within an optional argument. (You could create
% your own custom macro containing the \includegraphics command to make things
% simpler here.)
%\begin{IEEEbiography}[{\includegraphics[width=1in,height=1.25in,clip,keepaspectratio]{mshell}}]{Michael Shell}
% or if you just want to reserve a space for a photo:

%\begin{IEEEbiography}{Michael Shell}
%Biography text here.
%\end{IEEEbiography}
%
%% if you will not have a photo at all:
%\begin{IEEEbiographynophoto}{David C. Turner}
%received the Ph.D. degree from the University of Cambridge in 2009.
%
%Since 2010 he has worked as a software engineer at Tracsis plc.
%\end{IEEEbiographynophoto}

%
%% insert where needed to balance the two columns on the last page with
%% biographies
%%\newpage
%
%\begin{IEEEbiographynophoto}{Jane Doe}
%Biography text here.
%\end{IEEEbiographynophoto}

% You can push biographies down or up by placing
% a \vfill before or after them. The appropriate
% use of \vfill depends on what kind of text is
% on the last page and whether or not the columns
% are being equalized.

\vfill

% Can be used to pull up biographies so that the bottom of the last one
% is flush with the other column.
%\enlargethispage{-5in}



% that's all folks
\end{document}


